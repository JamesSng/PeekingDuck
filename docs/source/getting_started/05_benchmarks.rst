*******************
CV Model Benchmarks
*******************

PeekingDuck is equipped with a wide range of models for different scenarios, from real-time object detection to high-accuracy
pose estimation. The full list of models can be found :mod:`here <peekingduck.pipeline.nodes.model>`.

Given various constraints, such as hardware and costs, users are often faced with a tough trade-off between 
inference speed and model accuracy. Hence, we prepared the following benchmarks to help users choose the most suitable model for 
their application. These benchmarks are obtained using PeekingDuck's ``model`` nodes, and are measured in Frames Per Second (FPS) for 
inference speed and mean average precision (mAP) for model accuracy. 


Inference Speed
===============

Test Hardware
-------------
We ran FPS benchmarks on the following devices to compare CPU vs GPU performance:
 | - CPU: MacBook Pro 2017, with 2.9 GHz Quad-Core Intel Core i7 and 16GB RAM
 | - GPU: NVIDIA A100, paired with 2.2 GHz 6-Core Intel Xeon CPU and 85GB RAM

Test Conditions
---------------
The following test conditions were followed:
 | - ``input.recorded``, the model of interest, and ``dabble.fps`` nodes were used to perform inference on videos
 | - 2 videos were used to benchmark each model, one with only 1 human (``single``), and the other with multiple humans (``multiple``)
 | - Both videos are about 1 minute each, recorded at ~30 FPS, which translates to about 1,800 frames to process per video
 | - 1280x720 (HD ready) resolution was used, as a bridge between 640x480 (VGA) of poorer quality webcams, and 1920x1080 (Full HD) of CCTVs
 | - All unnecessary processes, such as browsers, were closed to prevent IO/resource contention

Results
-------
The results below show the FPS (Frames Per Second) of each model type.

+------------------------------------------+-------------------+-------------------+
|                                          |  MacBook Pro 2017 |    NVIDIA A100    |
+------------------+--------------+--------+--------+----------+--------+----------+
|       Task       |     Model    |  Type  | single | multiple | single | multiple |
+------------------+--------------+--------+--------+----------+--------+----------+
| Object Detection |     YOLO     | v4tiny |  22.42 |   21.71  |  65.24 |   57.50  |
|                  +--------------+--------+--------+----------+--------+----------+
|                  |     YOLO     |   v4   |  2.62  |   2.59   |  30.40 |   28.71  |
|                  +--------------+--------+--------+----------+--------+----------+
|                  | EfficientDet |    0   |  5.24  |   5.25   |  29.51 |   29.39  |
|                  +--------------+--------+--------+----------+--------+----------+
|                  | EfficientDet |    1   |  2.53  |   2.49   |  23.79 |   24.44  |
|                  +--------------+--------+--------+----------+--------+----------+
|                  | EfficientDet |    2   |  1.54  |   1.50   |  19.86 |   20.51  |
|                  +--------------+--------+--------+----------+--------+----------+
|                  | EfficientDet |    3   |  0.78  |   0.75   |  14.69 |   14.84  |
|                  +--------------+--------+--------+----------+--------+----------+
|                  | EfficientDet |    4   |  0.43  |   0.42   |  11.74 |   11.88  |
+------------------+--------------+--------+--------+----------+--------+----------+
|  Pose Estimation |    PoseNet   |   50   |  79.81 |   59.97  | 136.31 |   89.37  |
|                  +--------------+--------+--------+----------+--------+----------+
|                  |    PoseNet   |   75   |  67.96 |   50.98  | 132.84 |   83.73  |
|                  +--------------+--------+--------+----------+--------+----------+
|                  |    PoseNet   |   100  |  50.84 |   41.02  | 132.73 |   81.24  |
|                  +--------------+--------+--------+----------+--------+----------+
|                  |    PoseNet   | resnet |  15.27 |   14.32  |  73.15 |   51.65  |
|                  +--------------+--------+--------+----------+--------+----------+
|                  | HRNet + YOLO | v4tiny |  5.86  |   1.09   |  21.91 |   13.86  |
+------------------+--------------+--------+--------+----------+--------+----------+

Model Accuracy
=================

We evaluated the accuracy of the models using the MS COCO (val 2017) dataset. We integrated the COCO API into the PeekingDuck pipeline
for loading the annotations and evaluating the outputs from the models. 12 metrics are used for characterizing the performance
of the models. The definition of these metrics can be found `here <https://cocodataset.org/#detection-eval>`_. All values are reported
in percentage.

Results
-------
For object detection, all 80 object categories in the MS COCO (val 2017) dataset were processed. 

+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Object Detection                                                                                                                                                                                                                                                              |
+--------------+--------+------+----------------------+----------------------+--------------------+---------------------+---------------------+--------------------+---------------------+----------------------+--------------------+---------------------+--------------------+
| Model        | Type   | AP   | AP :sup:`IoU=.50`    | AP :sup:`IoU=.75`    | AP :sup:`small`    | AP :sup:`medium`    | AP :sup:`large`     | AR :sup:`max=1`    | AR :sup:`max=10`    | AR :sup:`max=100`    | AR :sup:`small`    | AR :sup:`medium`    | AR :sup:`large`    |
+--------------+--------+------+----------------------+----------------------+--------------------+---------------------+---------------------+--------------------+---------------------+----------------------+--------------------+---------------------+--------------------+
| YOLO         | v4tiny | 13.4 | 24.6                 | 13.1                 | 3.7                | 15.4                | 20.5                | 12.9               | 16.7                | 16.8                 | 4.2                | 18.7                | 26.6               |
+--------------+--------+------+----------------------+----------------------+--------------------+---------------------+---------------------+--------------------+---------------------+----------------------+--------------------+---------------------+--------------------+
| YOLO         | v4     | 38.2 | 55.4                 | 42.3                 | 18.3               | 43.0                | 55.4                | 29.8               | 42.5                | 43.1                 | 20.3               | 48.0                | 62.9               |
+--------------+--------+------+----------------------+----------------------+--------------------+---------------------+---------------------+--------------------+---------------------+----------------------+--------------------+---------------------+--------------------+
| EfficientDet | 0      | 26.4 | 39.2                 | 28.8                 | 6.4                | 30.2                | 44.6                | 23.0               | 30.9                | 31.1                 | 6.5                | 34.8                | 53.6               |
+--------------+--------+------+----------------------+----------------------+--------------------+---------------------+---------------------+--------------------+---------------------+----------------------+--------------------+---------------------+--------------------+
| EfficientDet | 1      | 31.5 | 45.4                 | 34.3                 | 11.8               | 35.3                | 50.4                | 26.3               | 36.2                | 36.6                 | 12.8               | 40.4                | 58.5               |
+--------------+--------+------+----------------------+----------------------+--------------------+---------------------+---------------------+--------------------+---------------------+----------------------+--------------------+---------------------+--------------------+
| EfficientDet | 2      | 34.6 | 48.8                 | 38.1                 | 15.4               | 38.8                | 52.5                | 28.4               | 39.5                | 39.9                 | 16.9               | 44.1                | 60.6               |
+--------------+--------+------+----------------------+----------------------+--------------------+---------------------+---------------------+--------------------+---------------------+----------------------+--------------------+---------------------+--------------------+
| EfficientDet | 3      | 37.4 | 51.7                 | 40.9                 | 19.0               | 40.7                | 55.5                | 30.3               | 42.6                | 43.0                 | 21.0               | 46.2                | 63.4               |
+--------------+--------+------+----------------------+----------------------+--------------------+---------------------+---------------------+--------------------+---------------------+----------------------+--------------------+---------------------+--------------------+
| EfficientDet | 4      | 40.0 | 54.4                 | 44.1                 | 21.3               | 44.3                | 57.2                | 31.8               | 45.4                | 46.0                 | 23.5               | 49.9                | 65.1               |
+--------------+--------+------+----------------------+----------------------+--------------------+---------------------+---------------------+--------------------+---------------------+----------------------+--------------------+---------------------+--------------------+

For pose estimation, all images in the 'person' category in the MS COCO (val 2017) dataset were processed. 

+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Pose Estimation                                                                                                                                                                                                                     |
+--------------+--------+------+----------------------+----------------------+---------------------+---------------------+--------------------+---------------------+----------------------+---------------------+--------------------+
| Model        | Type   | AP   | AP :sup:`IoU=.50`    | AP :sup:`IoU=.75`    | AP :sup:`medium`    | AP :sup:`large`     | AR :sup:`max=1`    | AR :sup:`max=10`    | AR :sup:`max=100`    | AR :sup:`medium`    | AR :sup:`large`    |
+--------------+--------+------+----------------------+----------------------+---------------------+---------------------+--------------------+---------------------+----------------------+---------------------+--------------------+
| PoseNet      | 50     | 5.2  | 15.4                 | 2.7                  | 0.8                 | 11.9                | 9.6                | 22.7                | 7.1                  | 1.4                 | 20.7               |
+--------------+--------+------+----------------------+----------------------+---------------------+---------------------+--------------------+---------------------+----------------------+---------------------+--------------------+
| PoseNet      | 75     | 7.2  | 19.7                 | 3.6                  | 1.3                 | 16.0                | 12.0               | 26.5                | 9.3                  | 2.2                 | 25.4               |
+--------------+--------+------+----------------------+----------------------+---------------------+---------------------+--------------------+---------------------+----------------------+---------------------+--------------------+
| PoseNet      | 100    | 7.8  | 20.8                 | 4.4                  | 1.5                 | 17.1                | 12.6               | 27.7                | 10.1                 | 2.4                 | 26.6               |
+--------------+--------+------+----------------------+----------------------+---------------------+---------------------+--------------------+---------------------+----------------------+---------------------+--------------------+
| PoseNet      | resnet | 11.9 | 27.4                 | 8.2                  | 2.2                 | 25.3                | 17.3               | 32.5                | 15.8                 | 2.9                 | 36.8               |
+--------------+--------+------+----------------------+----------------------+---------------------+---------------------+--------------------+---------------------+----------------------+---------------------+--------------------+
| HRNet + YOLO | v4tiny | 33.3 | 56.0                 | 35.1                 | 27.1                | 42.0                | 37.3               | 58.0                | 39.6                 | 29.6                | 47.9               |
+--------------+--------+------+----------------------+----------------------+---------------------+---------------------+--------------------+---------------------+----------------------+---------------------+--------------------+
